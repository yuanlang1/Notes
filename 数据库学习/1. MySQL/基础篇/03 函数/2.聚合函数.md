# 聚合函数

- [聚合函数](#聚合函数)
  - [1. 常见的几个聚合函数](#1-常见的几个聚合函数)
    - [1.1 `AVG`/`SUM`：适用于数值类型](#11-avgsum适用于数值类型)
    - [1.2 `MAX`/`MIN`](#12-maxmin)
    - [1.3 `COUNT`](#13-count)
      - [1.3.1 计算指定字段中在查询结构中出现的个数](#131-计算指定字段中在查询结构中出现的个数)
      - [1.3.2  COUNT(字段)不计算NULL](#132--count字段不计算null)
      - [1.3.3 `AVG`=`SUM`/`COUNT`](#133-avgsumcount)
  - [2. `GROUP BY`](#2-group-by)
    - [2.1 应用](#21-应用)
    - [2.2 结论](#22-结论)
    - [2.3 `group by`中使用`with rollup`](#23-group-by中使用with-rollup)
  - [3. `HAVING`：过滤数据 用于聚合函数](#3-having过滤数据-用于聚合函数)
    - [3.1 使用方式](#31-使用方式)
    - [3.2 结论](#32-结论)

---

## 1. 常见的几个聚合函数

---

### 1.1 `AVG`/`SUM`：适用于数值类型

```sql
对于字符串没有意义
AVG -> average 平均值
SUM -> sum 和 

例如：
select AVG(salary),SUM(salary)
from employees;   求所有员工工资的平均值和总和

结果：
+-------------+-------------+
| AVG(salary) | SUM(salary) |
+-------------+-------------+
| 6461.682243 |   691400.00 |
+-------------+-------------+
```

---

### 1.2 `MAX`/`MIN`

```sql
MAX -> 最大值
MIN -> 最小值

例如：
select MAX(salary),MIN(salary),MAX(last_name),MIN(last_name)
from employees;

结果：
+-------------+-------------+----------------+----------------+
| MAX(salary) | MIN(salary) | MAX(last_name) | MIN(last_name) |
+-------------+-------------+----------------+----------------+
|    24000.00 |     2100.00 | Zlotkey        | Abel           |
+-------------+-------------+----------------+----------------+
```

---

### 1.3 `COUNT`

#### 1.3.1 计算指定字段中在查询结构中出现的个数

```sql
select COUNT(employee_id),COUNT(salary),COUNT(salary*2),COUNT(1)
from employees;

结果：
+--------------------+---------------+-----------------+----------+
| COUNT(employee_id) | COUNT(salary) | COUNT(salary*2) | COUNT(1) |
+--------------------+---------------+-----------------+----------+
|                107 |           107 |             107 |      107 |
+--------------------+---------------+-----------------+----------+

求表中多少条数据：COUNT(*),COUNT(1) 
```

#### 1.3.2  COUNT(字段)不计算NULL

```sql
例如：
select COUNT(*),COUNT(commission_pct)
from employees;

结果：
+----------+-----------------------+
| COUNT(*) | COUNT(commission_pct) |
+----------+-----------------------+
|      107 |                    35 |
+----------+-----------------------+
```

#### 1.3.3 `AVG`=`SUM`/`COUNT`

```sql
例如：
select SUM(salary)/COUNT(salary),AVG(salary)
from employees;

结果：
+---------------------------+-------------+
| SUM(salary)/COUNT(salary) | AVG(salary) |
+---------------------------+-------------+
|               6461.682243 | 6461.682243 |
+---------------------------+-------------+
```

---

## 2. `GROUP BY`

### 2.1 应用

```sql
分组查询  

例如：
查询各个部门的平均工资，最高工资   -> 按照部门号进行分组
select employee_id,AVG(salary),MAX(salary)
from employees
group by department_id;

结果：
+---------------+--------------+-------------+
| department_id | AVG(salary)  | MAX(salary) |
+---------------+--------------+-------------+
|          NULL |  7000.000000 |     7000.00 |
|            10 |  4400.000000 |     4400.00 |
|            20 |  9500.000000 |    13000.00 |
|            30 |  4150.000000 |    11000.00 |
|            40 |  6500.000000 |     6500.00 |
|            50 |  3475.555556 |     8200.00 |
|            60 |  5760.000000 |     9000.00 |
|            70 | 10000.000000 |    10000.00 |
|            80 |  8955.882353 |    14000.00 |
|            90 | 19333.333333 |    24000.00 |
|           100 |  8600.000000 |    12000.00 |
|           110 | 10150.000000 |    12000.00 |
+---------------+--------------+-------------+

查看各个job_id的平均工资   -> 按照job_id分组
select job_id,AVG(salary)
from employees
group by job_id;

结果：
+------------+--------------+
| job_id     | AVG(salary)  |
+------------+--------------+
| AC_ACCOUNT |  8300.000000 |
| AC_MGR     | 12000.000000 |
| AD_ASST    |  4400.000000 |
| AD_PRES    | 24000.000000 |
| AD_VP      | 17000.000000 |
| FI_ACCOUNT |  7920.000000 |
| FI_MGR     | 12000.000000 |
| HR_REP     |  6500.000000 |
| IT_PROG    |  5760.000000 |
| MK_MAN     | 13000.000000 |
| MK_REP     |  6000.000000 |
| PR_REP     | 10000.000000 |
| PU_CLERK   |  2780.000000 |
| PU_MAN     | 11000.000000 |
| SA_MAN     | 12200.000000 |
| SA_REP     |  8350.000000 |
| SH_CLERK   |  3215.000000 |
| ST_CLERK   |  2785.000000 |
| ST_MAN     |  7280.000000 |
+------------+--------------+

查询各个department_id,job_id的平均工资
select department_id,job_id,AVG(salary)
from employees
group by department_id,job_id;

结果：
+---------------+------------+--------------+
| department_id | job_id     | AVG(salary)  |
+---------------+------------+--------------+
|          NULL | SA_REP     |  7000.000000 |
|            10 | AD_ASST    |  4400.000000 |
|            20 | MK_MAN     | 13000.000000 |
|            20 | MK_REP     |  6000.000000 |
|            30 | PU_CLERK   |  2780.000000 |
|            30 | PU_MAN     | 11000.000000 |
|            40 | HR_REP     |  6500.000000 |
|            50 | SH_CLERK   |  3215.000000 |
|            50 | ST_CLERK   |  2785.000000 |
|            50 | ST_MAN     |  7280.000000 |
|            60 | IT_PROG    |  5760.000000 |
|            70 | PR_REP     | 10000.000000 |
|            80 | SA_MAN     | 12200.000000 |
|            80 | SA_REP     |  8396.551724 |
|            90 | AD_PRES    | 24000.000000 |
|            90 | AD_VP      | 17000.000000 |
|           100 | FI_ACCOUNT |  7920.000000 |
|           100 | FI_MGR     | 12000.000000 |
|           110 | AC_ACCOUNT |  8300.000000 |
|           110 | AC_MGR     | 12000.000000 |
+---------------+------------+--------------+
```

### 2.2 结论

```sql
结论1： from + where + group by + order by + limit
结论2： group by 中声明的字段可以不出现在 select 中，但是 select 中声明的字段必须出现在 group by 中
```

### 2.3 `group by`中使用`with rollup`

```sql
with rollup 与 order by 互斥

select department_id,AVG(salary)
from employees
group by department_id with rollup;  -> 会求一个平均值

结果：
+---------------+--------------+
| department_id | AVG(salary)  |
+---------------+--------------+
|          NULL |  7000.000000 |
|            10 |  4400.000000 |
|            20 |  9500.000000 |
|            30 |  4150.000000 |
|            40 |  6500.000000 |
|            50 |  3475.555556 |
|            60 |  5760.000000 |
|            70 | 10000.000000 |
|            80 |  8955.882353 |
|            90 | 19333.333333 |
|           100 |  8600.000000 |
|           110 | 10150.000000 |
|          NULL |  6461.682243 |
+---------------+--------------+
```

---

## 3. `HAVING`：过滤数据 用于聚合函数

### 3.1 使用方式

```sql
用于聚合函数的过滤条件，必须和 group by 一起使用

例如：
查询各个部门中最高工资比10000高的部门信息
select department_id,MAX(salary)
from employees
group by department_id
having MAX(salary)>10000;

结果：
+---------------+-------------+
| department_id | MAX(salary) |
+---------------+-------------+
|            20 |    13000.00 |
|            30 |    11000.00 |
|            80 |    14000.00 |
|            90 |    24000.00 |
|           100 |    12000.00 |
|           110 |    12000.00 |
+---------------+-------------+


查询部门号位10,20,30,40，这四个部门中最高工资>10000的部门信息
方式1： -> 推荐，效率更高
select department_id,MAX(salary)
from employees
where department_id in (10,20,30,40)
group by department_id
having max(salary)>10000;

结果：
+---------------+-------------+
| department_id | MAX(salary) |
+---------------+-------------+
|            20 |    13000.00 |
|            30 |    11000.00 |
+---------------+-------------+
方式2：
select department_id,MAX(salary)
from employees
group by department_id
having MAX(salary)>10000 and department_id in (10,20,30,40);
```

### 3.2 结论

```sql
当过滤条件中有聚合函数时，则过滤条件必须声明having
当过滤条件中不包含聚合条件时，则过滤条件声明在where中或having中都可以
```
